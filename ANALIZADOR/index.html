<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRI_DATA_EXPERT // ACCOUNTING_OS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-color: #141414;
            --border-color: #333;
            --accent-color: #555;
            --text-main: #b0b0b0;
            --highlight: #ffffff;
            --expert-gold: #a89360; /* Color distintivo para el análisis contable */
            --font-mono: 'Share Tech Mono', 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-mono);
            padding: 2rem;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
            background: var(--panel-color);
        }

        header {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            background: #000;
        }

        /* --- Secciones Principales --- */
        .layout-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            border-bottom: 1px solid var(--border-color);
        }

        .main-panel { border-right: 1px solid var(--border-color); }

        /* --- Upload Area --- */
        .upload-area {
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .file-box {
            border: 1px dashed var(--accent-color);
            padding: 2rem;
            position: relative;
            cursor: pointer;
        }

        .file-box:hover { background: #1a1a1a; }
        input[type="file"] { position: absolute; opacity: 0; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; }

        /* --- Módulo de Análisis Inteligente --- */
        .analysis-panel {
            padding: 2rem;
            background: #0a0a0a;
            font-size: 0.9rem;
        }

        .analysis-title {
            color: var(--expert-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--expert-gold);
            padding-bottom: 5px;
        }

        .analysis-result {
            background: #111;
            padding: 1.5rem;
            border-left: 3px solid var(--expert-gold);
            line-height: 1.8;
        }

        .val-highlight { color: var(--highlight); font-weight: bold; }

        /* --- Tabla --- */
        .table-container { height: 400px; overflow-y: auto; padding: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { background: #1a1a1a; color: var(--accent-color); padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #1a1a1a; }

        /* --- Footer --- */
        .controls { padding: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end; }
        button {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--text-main);
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { background: #fff; color: #000; }
        .btn-download { border-color: var(--expert-gold); color: var(--expert-gold); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div>SISTEMA DE PROCESAMIENTO TRIBUTARIO // ECUADOR</div>
            <div id="status" style="color: var(--expert-gold)">ESPERANDO_ARCHIVOS...</div>
        </header>

        <section class="layout-grid">
            <div class="main-panel">
                <div class="upload-area">
                    <div class="file-box">
                        [ CARGAR ARCHIVOS TXT DEL SRI (MULTIPLE) ]
                        <input type="file" id="fileInput" multiple accept=".txt">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Emisión</th>
                                <th>Razón Social</th>
                                <th>Comprobante</th>
                                <th>Subtotal</th>
                                <th>IVA</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="analysis-panel">
                <h2 class="analysis-title">Análisis Inteligente (Normativa EC)</h2>
                <div id="analysisOutput" class="analysis-result">
                    <p>Suba uno o más archivos para generar el desglose tributario automático.</p>
                </div>
            </div>
        </section>

        <footer class="controls">
            <button onclick="reset()">Reiniciar</button>
            <button class="btn-download" id="btnXlsx" onclick="exportExcel()" disabled>Descargar Reporte Excel</button>
        </footer>
    </div>

    <script>
        let invoices = [];
        const RATES = [0.15, 0.08]; // Tarifas vigentes para análisis

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            for (let file of files) {
                const text = await file.text();
                processText(text);
            }
            render();
        });

        function processText(content) {
            const lines = content.split('\n');
            lines.forEach((line, index) => {
                if (index === 0 || !line.trim()) return;
                const cols = line.split('\t').map(c => c.trim());
                
                if (cols.length >= 11) {
                    invoices.push({
                        ruc: cols[0],
                        empresa: cols[1],
                        tipo: cols[2],
                        numero: cols[3],
                        clave: cols[4],
                        fecha: cols[6],
                        subtotal: parseFloat(cols[8] || 0),
                        iva: parseFloat(cols[9] || 0),
                        total: parseFloat(cols[10] || 0)
                    });
                }
            });
        }

        function runIntelligentAnalysis() {
            let totalSubtotal = 0, totalIva = 0, totalPagado = 0;
            let base15 = 0, iva15 = 0, base8 = 0, iva8 = 0, base0 = 0;

            invoices.forEach(inv => {
                totalSubtotal += inv.subtotal;
                totalIva += inv.iva;
                totalPagado += inv.total;

                if (inv.iva > 0) {
                    // Lógica de detección: Intentamos cuadrar con 15% (estándar) o 8% (turismo)
                    let calcBase15 = inv.iva / 0.15;
                    let calcBase8 = inv.iva / 0.08;

                    // Si el IVA dividido para 0.15 es cercano al subtotal, es tarifa 15%
                    if (Math.abs(calcBase15 - inv.subtotal) < 0.05) {
                        base15 += inv.subtotal;
                        iva15 += inv.iva;
                    } 
                    // Si el IVA dividido para 0.08 cuadra, es tarifa 8%
                    else if (Math.abs(calcBase8 - inv.subtotal) < 0.05) {
                        base8 += inv.subtotal;
                        iva8 += inv.iva;
                    }
                    // Si es una factura mixta (parte 15%, parte 0%)
                    else {
                        base15 += calcBase15;
                        iva15 += inv.iva;
                        base0 += (inv.subtotal - calcBase15);
                    }
                } else {
                    base0 += inv.subtotal;
                }
            });

            // Verificación
            const verificacion = (totalSubtotal + totalIva).toFixed(2) === totalPagado.toFixed(2) ? "SISTEMA VERIFICADO" : "DISCREPANCIA DETECTADA";

            return `
                <div style="margin-bottom:10px; font-size: 0.7rem; opacity: 0.7;">STATUS: ${verificacion}</div>
                
                <p>Base 15%: <span class="val-highlight">$${base15.toFixed(2)}</span></p>
                <p>IVA 15%: <span class="val-highlight">$${iva15.toFixed(2)}</span></p>
                <div style="margin: 5px 0; border-bottom: 1px solid #222;"></div>
                <p>Base 8%: <span class="val-highlight">$${base8.toFixed(2)}</span></p>
                <p>IVA 8%: <span class="val-highlight">$${iva8.toFixed(2)}</span></p>
                <div style="margin: 5px 0; border-bottom: 1px solid #222;"></div>
                <p>Base 0%: <span class="val-highlight">$${base0.toFixed(2)}</span></p>
                <div style="margin: 15px 0; border-bottom: 2px solid var(--expert-gold);"></div>
                <p>Subtotal sin impuestos: <span class="val-highlight">$${totalSubtotal.toFixed(2)}</span></p>
                <p>IVA total: <span class="val-highlight">$${totalIva.toFixed(2)}</span></p>
                <p style="font-size: 1.1rem">Total pagado: <span class="val-highlight" style="color:var(--expert-gold)">$${totalPagado.toFixed(2)}</span></p>
            `;
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = invoices.map(inv => `
                <tr>
                    <td>${inv.fecha}</td>
                    <td>${inv.empresa}</td>
                    <td>${inv.numero}</td>
                    <td>$${inv.subtotal.toFixed(2)}</td>
                    <td>$${inv.iva.toFixed(2)}</td>
                    <td>$${inv.total.toFixed(2)}</td>
                </tr>
            `).join('');

            document.getElementById('analysisOutput').innerHTML = runIntelligentAnalysis();
            document.getElementById('btnXlsx').disabled = false;
            document.getElementById('status').innerText = 'PROCESAMIENTO_COMPLETO';
        }

        function reset() {
            invoices = [];
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('analysisOutput').innerHTML = '<p>Suba uno o más archivos para generar el desglose.</p>';
            document.getElementById('btnXlsx').disabled = true;
            document.getElementById('status').innerText = 'ESPERANDO_ARCHIVOS...';
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(invoices.map(i => ({
                "Fecha Emision": i.fecha,
                "RUC Emisor": i.ruc,
                "Empresa": i.empresa,
                "Comprobante": i.numero,
                "Subtotal": i.subtotal,
                "IVA": i.iva,
                "Total": i.total,
                "Clave Acceso": i.clave
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "SRI_Export");
            XLSX.writeFile(wb, "Reporte_SRI_Contable.xlsx");
        }
    </script>
</body>
</html>